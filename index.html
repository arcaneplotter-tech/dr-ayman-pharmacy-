<!DOCTYPE html>
<html lang="en" :dir="lang === 'ar' ? 'rtl' : 'ltr'">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø¯ÙŠ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Alpine.js Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- SheetJS & PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        [x-cloak] { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900" x-data="pharmaApp()" x-init="initApp()">

    <!-- Header -->
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" @click="resetApp()">
                <div class="bg-emerald-600 p-2 rounded-xl text-white">
                    <i data-lucide="pill" class="w-6 h-6"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-slate-900 hidden sm:block">
                    <span x-text="lang === 'ar' ? 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø¯ÙŠ' : 'El-Nagdy Pharmacy'"></span>
                </h1>
            </div>

            <!-- Search Bar (Only visible when loaded) -->
            <div class="flex-1 max-w-xl mx-8 hidden md:block" x-show="hasLoaded" x-cloak>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 rtl:left-auto rtl:right-4"></i>
                    <input
                        type="text"
                        :placeholder="lang === 'ar' ? 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...' : 'Search products...'"
                        x-model="searchQuery"
                        class="w-full pl-12 pr-4 rtl:pl-4 rtl:pr-12 py-2.5 bg-slate-100 border-transparent focus:bg-white border focus:border-emerald-500 rounded-xl transition-all outline-none"
                    />
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button
                    @click="toggleLanguage()"
                    class="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold transition-colors text-sm"
                >
                    <span x-text="lang === 'ar' ? 'English' : 'Ø¹Ø±Ø¨ÙŠ'"></span>
                </button>

                <button
                    @click="fetchGoogleSheet()"
                    class="p-2.5 text-slate-500 hover:bg-slate-100 hover:text-slate-700 rounded-xl transition-colors flex items-center gap-2 text-sm font-medium"
                    title="Refresh Data"
                >
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>

                <button
                    @click="isCartOpen = true"
                    class="relative p-3 hover:bg-emerald-50 text-slate-600 hover:text-emerald-600 rounded-xl transition-colors group"
                >
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span 
                        x-show="cartTotalItems > 0" 
                        x-text="cartTotalItems"
                        class="absolute top-1 right-1 bg-emerald-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white shadow-sm"
                    ></span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- Loading State -->
        <div x-show="isLoading" class="min-h-[60vh] flex flex-col items-center justify-center text-center space-y-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
            <p class="text-slate-500">Loading products...</p>
        </div>

        <!-- Error State -->
        <div x-show="error && !isLoading" class="min-h-[60vh] flex flex-col items-center justify-center text-center space-y-4" x-cloak>
            <div class="bg-red-100 p-4 rounded-full text-red-600">
                <i data-lucide="alert-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-lg font-semibold text-slate-900">Failed to load data</h3>
            <p class="text-slate-500 max-w-md" x-text="error"></p>
            <button 
                @click="fetchGoogleSheet()"
                class="px-6 py-2 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition-colors"
            >
                Try Again
            </button>
        </div>

        <!-- Shop View -->
        <div x-show="hasLoaded && !isLoading" x-cloak>
            
            <!-- Pharmacy Title -->
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">
                    <span x-text="lang === 'ar' ? 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø¯ÙŠ' : 'El-Nagdy Pharmacy'"></span>
                </h2>
                <div class="h-1 w-20 bg-emerald-500 mx-auto rounded-full"></div>
            </div>

            <!-- Mobile Search -->
            <div class="md:hidden mb-6">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 rtl:left-auto rtl:right-4"></i>
                    <input
                        type="text"
                        :placeholder="lang === 'ar' ? 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...' : 'Search products...'"
                        x-model="searchQuery"
                        class="w-full pl-12 pr-4 rtl:pl-4 rtl:pr-12 py-3 bg-white border border-slate-200 rounded-xl shadow-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none"
                    />
                </div>
            </div>

            <!-- Categories & Sort -->
            <div class="mb-8 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center" x-show="hasLoaded" x-cloak>
                <div class="overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0 sm:px-0 scrollbar-hide flex-1 max-w-full">
                    <div class="flex gap-2 min-w-max">
                        <button
                            @click="activeCategory = null"
                            class="px-4 py-2 rounded-full text-sm font-medium transition-all border"
                            :class="activeCategory === null ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'"
                        >
                            All Products
                        </button>
                        <template x-for="cat in categories" :key="cat">
                            <button
                                @click="activeCategory = cat"
                                class="px-4 py-2 rounded-full text-sm font-medium transition-all border"
                                :class="activeCategory === cat ? 'bg-emerald-600 text-white border-emerald-600 shadow-md shadow-emerald-100' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'"
                                x-text="cat"
                            ></button>
                        </template>
                    </div>
                </div>

                <div class="relative min-w-[200px]">
                    <select 
                        x-model="sortBy"
                        class="w-full appearance-none bg-white border border-slate-200 text-slate-700 py-2 pl-4 pr-10 rtl:pl-10 rtl:pr-4 rounded-xl focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 cursor-pointer text-sm font-medium"
                    >
                        <option value="name-asc" x-text="lang === 'ar' ? 'Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)' : 'Name (A-Z)'"></option>
                        <option value="name-desc" x-text="lang === 'ar' ? 'Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)' : 'Name (Z-A)'"></option>
                        <option value="price-asc" x-text="lang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰)' : 'Price (Low to High)'"></option>
                        <option value="price-desc" x-text="lang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„)' : 'Price (High to Low)'"></option>
                        <option value="company-asc" x-text="lang === 'ar' ? 'Ø§Ù„Ø´Ø±ÙƒØ© (Ø£-ÙŠ)' : 'Company (A-Z)'"></option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 rtl:right-auto rtl:left-0 flex items-center px-3 text-slate-500">
                        <i data-lucide="arrow-up-down" class="w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <template x-for="product in filteredProducts" :key="product.id">
                    <div class="group relative bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden flex flex-col h-full">
                        <div class="p-5 flex flex-col flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="bg-emerald-50 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider" x-text="product.category || 'Medicine'"></div>
                                <div class="text-lg font-bold text-slate-900 font-mono">
                                    <span x-text="product.price.toFixed(2)"></span> <span class="text-xs text-slate-500 font-sans">EGP</span>
                                </div>
                            </div>

                            <h3 class="text-lg font-semibold text-slate-900 mb-1 leading-tight group-hover:text-emerald-600 transition-colors" x-text="getLocalizedName(product)"></h3>
                            
                            <div class="text-xs text-slate-500 mb-4 font-medium" x-text="product.company"></div>

                            <div class="mt-auto space-y-3">
                                <div class="bg-slate-50 p-3 rounded-xl">
                                    <div class="flex items-center gap-2 text-xs font-semibold text-slate-700 mb-1">
                                        <i data-lucide="info" class="w-3 h-3 text-blue-500"></i>
                                        Active Ingredient
                                    </div>
                                    <p class="text-sm text-slate-600 line-clamp-2" x-text="product.activeIngredient"></p>
                                </div>

                                <div class="text-sm text-slate-500 line-clamp-2" x-text="product.description"></div>
                            </div>
                        </div>

                        <div class="p-4 pt-0 mt-auto">
                            <button
                                @click="addToCart(product)"
                                class="w-full flex items-center justify-center gap-2 bg-slate-900 hover:bg-emerald-600 text-white py-2.5 rounded-xl transition-colors duration-200 font-medium text-sm active:scale-95"
                            >
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div x-show="filteredProducts.length === 0" class="text-center py-20" x-cloak>
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-400">
                    <i data-lucide="filter" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-semibold text-slate-900 mb-2">No products found</h3>
                <p class="text-slate-500">Try adjusting your search or filters</p>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div 
        x-show="toast.visible" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-2"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-2"
        class="fixed bottom-4 right-4 z-50 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3"
        x-cloak
    >
        <div class="bg-emerald-500 rounded-full p-1">
            <i data-lucide="check" class="w-4 h-4 text-white"></i>
        </div>
        <span x-text="toast.message" class="font-medium text-sm"></span>
    </div>

    <!-- Checkout Form Modal -->
    <div x-show="showCheckoutForm" x-trap.noscroll="showCheckoutForm" class="relative z-[60]" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-cloak>
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" x-transition.opacity></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div 
                    class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
                    x-transition:enter="ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave="ease-in duration-200"
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                >
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-emerald-100 sm:mx-0 sm:h-10 sm:w-10">
                                <i data-lucide="map-pin" class="h-6 w-6 text-emerald-600"></i>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-xl font-semibold leading-6 text-slate-900" id="modal-title">
                                    <span x-text="lang === 'ar' ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„' : 'Delivery Details'"></span>
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">
                                            <span x-text="lang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ' : 'Customer Name'"></span>
                                        </label>
                                        <input type="text" x-model="customer.name" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-slate-900 focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">
                                            <span x-text="lang === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Address'"></span>
                                        </label>
                                        <textarea x-model="customer.address" rows="2" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-slate-900 focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">
                                            <span x-text="lang === 'ar' ? 'Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©' : 'Landmark'"></span>
                                        </label>
                                        <input type="text" x-model="customer.landmark" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-slate-900 focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                        <button 
                            type="button" 
                            @click="confirmOrder()"
                            class="inline-flex w-full justify-center rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 sm:ml-3 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="!customer.name || !customer.address"
                        >
                            <span x-text="lang === 'ar' ? 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨' : 'Confirm Order'"></span>
                        </button>
                        <button 
                            type="button" 
                            @click="showCheckoutForm = false"
                            class="mt-3 inline-flex w-full justify-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto"
                        >
                            <span x-text="lang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div x-show="isCartOpen" class="relative z-50" aria-labelledby="slide-over-title" role="dialog" aria-modal="true" x-cloak>
        <div class="fixed inset-0 bg-black/20 backdrop-blur-sm transition-opacity" @click="isCartOpen = false"></div>

        <div class="fixed inset-0 overflow-hidden">
            <div class="absolute inset-0 overflow-hidden">
                <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                    <div class="pointer-events-auto w-screen max-w-md transform transition ease-in-out duration-500 sm:duration-700 bg-white shadow-xl flex flex-col h-full">
                        
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between bg-white">
                            <div class="flex items-center gap-3">
                                <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-semibold text-slate-900">
                                        <span x-text="lang === 'ar' ? 'Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª' : 'Shopping Cart'"></span>
                                    </h2>
                                    <p class="text-xs text-emerald-600 font-medium mb-0.5" x-text="lang === 'ar' ? 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø¯ÙŠ' : 'El-Nagdy Pharmacy'"></p>
                                    <p class="text-xs text-slate-500" x-text="cartTotalItems + (lang === 'ar' ? ' Ø¹Ù†Ø§ØµØ±' : ' items')"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button 
                                    @click="clearCart()" 
                                    class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors"
                                    x-show="cartItems.length > 0"
                                >
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    <span x-text="lang === 'ar' ? 'Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø©' : 'Clear Cart'"></span>
                                </button>
                                <button @click="isCartOpen = false" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-6 space-y-4">
                            <template x-if="cartItems.length === 0">
                                <div class="h-full flex flex-col items-center justify-center text-center space-y-4">
                                    <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-slate-300">
                                        <i data-lucide="shopping-cart" class="w-10 h-10"></i>
                                    </div>
                                    <div>
                                        <p class="text-slate-900 font-medium text-lg" x-text="lang === 'ar' ? 'Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©' : 'Your cart is empty'"></p>
                                        <p class="text-slate-500 text-sm mt-1 max-w-[200px] mx-auto" x-text="lang === 'ar' ? 'Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¹Ø¯.' : 'Looks like you haven\'t added any medicine yet.'"></p>
                                    </div>
                                    <button @click="isCartOpen = false" class="mt-4 px-6 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-colors">
                                        <span x-text="lang === 'ar' ? 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚' : 'Start Shopping'"></span>
                                    </button>
                                </div>
                            </template>

                            <template x-for="item in cartItems" :key="item.id">
                                <div class="flex gap-4 bg-white border border-slate-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-shadow">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-semibold text-slate-900 truncate pr-2" x-text="item.name"></h4>
                                            <button @click="removeFromCart(item.id)" class="text-slate-400 hover:text-red-500 transition-colors shrink-0">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                        <p class="text-xs text-slate-500 truncate mb-2" x-text="item.company"></p>
                                        
                                        <div class="flex items-center justify-between mt-3">
                                            <div class="text-sm font-mono font-bold text-emerald-600">
                                                <span x-text="(item.price * item.quantity).toFixed(2)"></span> EGP
                                            </div>
                                            
                                            <div class="flex items-center gap-3 bg-slate-50 rounded-lg border border-slate-200 p-1">
                                                <button @click="updateQuantity(item.id, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-white hover:shadow-sm rounded text-slate-600 transition-all" :disabled="item.quantity <= 1">
                                                    <i data-lucide="minus" class="w-3 h-3"></i>
                                                </button>
                                                <span class="text-sm font-semibold w-4 text-center text-slate-900" x-text="item.quantity"></span>
                                                <button @click="updateQuantity(item.id, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-white hover:shadow-sm rounded text-slate-600 transition-all">
                                                    <i data-lucide="plus" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="p-6 border-t border-slate-100 bg-slate-50 space-y-4" x-show="cartItems.length > 0">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between text-sm text-slate-500">
                                    <span x-text="lang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ' : 'Subtotal'"></span>
                                    <span><span x-text="cartSubtotal.toFixed(2)"></span> EGP</span>
                                </div>
                                <div class="flex items-center justify-between text-sm text-slate-500">
                                    <span x-text="lang === 'ar' ? 'Ø§Ù„ØªÙˆØµÙŠÙ„' : 'Delivery'"></span>
                                    <span><span x-text="deliveryFee.toFixed(2)"></span> EGP</span>
                                </div>
                                <div class="flex items-center justify-between text-lg font-bold text-slate-900 pt-2 border-t border-slate-200">
                                    <span x-text="lang === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'"></span>
                                    <span><span x-text="cartTotal.toFixed(2)"></span> EGP</span>
                                </div>
                            </div>
                            <button 
                                @click="checkout()"
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3.5 rounded-xl font-medium transition-all shadow-lg shadow-emerald-200 hover:shadow-emerald-300 flex items-center justify-center gap-2"
                            >
                                <span>Order via WhatsApp</span>
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function pharmaApp() {
            return {
                products: [],
                cartItems: [],
                searchQuery: '',
                hasLoaded: false,
                isLoading: true,
                error: null,
                isCartOpen: false,
                activeCategory: null,
                sortBy: 'name-asc',
                toast: { visible: false, message: '' },
                lang: 'ar', // Default to Arabic
                showCheckoutForm: false,
                deliveryFee: 10,
                customer: {
                    name: '',
                    address: '',
                    landmark: ''
                },
                fuse: null,
                
                initApp() {
                    // Initialize icons
                    lucide.createIcons();
                    
                    // Load cart from local storage
                    this.loadCart();

                    // Watch for changes to update icons
                    this.$watch('hasLoaded', () => setTimeout(() => lucide.createIcons(), 100));
                    this.$watch('cartItems', () => {
                        this.saveCart();
                        setTimeout(() => lucide.createIcons(), 100);
                    });
                    this.$watch('products', () => setTimeout(() => lucide.createIcons(), 100));

                    // Auto-fetch data
                    this.fetchGoogleSheet();
                },

                fetchGoogleSheet() {
                    this.isLoading = true;
                    this.error = null;
                    const sheetId = '1JHfI4RsTXZgu0X3njJhLja0oQ8LeWxlyshxoppxmLCk';
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;

                    Papa.parse(csvUrl, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            this.processData(results.data);
                            this.isLoading = false;
                        },
                        error: (err) => {
                            this.error = `Failed to load data: ${err.message}`;
                            this.isLoading = false;
                        }
                    });
                },

                toggleLanguage() {
                    this.lang = this.lang === 'en' ? 'ar' : 'en';
                    // Update sort direction if needed or re-sort
                },

                getLocalizedName(product) {
                    if (this.lang === 'ar' && product.arabicName) {
                        return product.arabicName;
                    }
                    return product.name;
                },

                showToast(message) {
                    this.toast.message = message;
                    this.toast.visible = true;
                    setTimeout(() => {
                        this.toast.visible = false;
                    }, 3000);
                },

                saveCart() {
                    localStorage.setItem('pharmaShopCart', JSON.stringify(this.cartItems));
                },

                loadCart() {
                    const saved = localStorage.getItem('pharmaShopCart');
                    if (saved) {
                        try {
                            this.cartItems = JSON.parse(saved);
                        } catch (e) {
                            console.error("Failed to load cart", e);
                        }
                    }
                },

                get categories() {
                    const cats = new Set(this.products.map(p => p.category).filter(Boolean));
                    return Array.from(cats);
                },

                get filteredProducts() {
                    let result = this.products;

                    // Fuzzy Search
                    if (this.searchQuery && this.fuse) {
                        const searchResults = this.fuse.search(this.searchQuery);
                        result = searchResults.map(res => res.item);
                    }

                    // Filter by Category
                    if (this.activeCategory) {
                        result = result.filter(product => product.category === this.activeCategory);
                    }

                    // Sorting Logic
                    return result.sort((a, b) => {
                        const nameA = this.getLocalizedName(a);
                        const nameB = this.getLocalizedName(b);

                        switch (this.sortBy) {
                            case 'price-asc':
                                return a.price - b.price;
                            case 'price-desc':
                                return b.price - a.price;
                            case 'name-asc':
                                return nameA.localeCompare(nameB);
                            case 'name-desc':
                                return nameB.localeCompare(nameA);
                            case 'company-asc':
                                return (a.company || '').localeCompare(b.company || '');
                            default:
                                return 0;
                        }
                    });
                },

                get cartTotalItems() {
                    return this.cartItems.reduce((acc, item) => acc + item.quantity, 0);
                },

                get cartSubtotal() {
                    return this.cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                },

                get cartTotal() {
                    return this.cartSubtotal + this.deliveryFee;
                },

                processData(rawData) {
                    try {
                        if (rawData.length === 0) throw new Error("File is empty");

                        // Helper to find key
                        const findKey = (keywords) => {
                            return Object.keys(rawData[0]).find(key => 
                                keywords.some(k => key.toLowerCase().includes(k))
                            );
                        };

                        const nameKey = findKey(['name', 'item', 'product', 'Ø§Ù„Ø§Ø³Ù…', 'english']);
                        const arabicNameKey = findKey(['arabic', 'ar_name', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù„Ø£Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ']);
                        const activeKey = findKey(['active', 'ingredient', 'composition', 'effect', 'Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø©']);
                        const companyKey = findKey(['company', 'manufacturer', 'Ø§Ù„Ø´Ø±ÙƒØ©']);
                        const priceKey = findKey(['price', 'cost', 'Ø§Ù„Ø³Ø¹Ø±']);
                        const descKey = findKey(['desc', 'form', 'dosage', 'type', 'description']);
                        const catKey = findKey(['category', 'class', 'group']);

                        if (!nameKey || !priceKey) {
                            throw new Error("Could not find required columns: Name and Price");
                        }

                        this.products = rawData.map((row, index) => ({
                            id: `imported-${index}-${Date.now()}`,
                            name: row[nameKey] || "Unknown Product",
                            arabicName: arabicNameKey ? row[arabicNameKey] : "",
                            activeIngredient: activeKey ? row[activeKey] : "N/A",
                            company: companyKey ? row[companyKey] : "Unknown Company",
                            price: parseFloat(row[priceKey]) || 0,
                            description: descKey ? row[descKey] : (row[nameKey] || ""),
                            category: catKey ? row[catKey] : "General"
                        })).filter(p => p.name && p.price > 0);

                        if (this.products.length === 0) throw new Error("No valid products found");

                        this.hasLoaded = true;
                        this.activeCategory = null;

                        // Initialize Fuse.js for fuzzy search
                        this.fuse = new Fuse(this.products, {
                            keys: ['name', 'arabicName', 'activeIngredient', 'company'],
                            threshold: 0.3, // 0.0 is perfect match, 1.0 is match anything
                            distance: 100,
                            minMatchCharLength: 2
                        });
                        
                    } catch (err) {
                        this.error = err.message || "Failed to parse file";
                    }
                },

                resetApp() {
                    // Re-fetch data
                    this.fetchGoogleSheet();
                },

                addToCart(product) {
                    const existing = this.cartItems.find(item => item.id === product.id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.cartItems.push({ ...product, quantity: 1 });
                    }
                    const name = this.getLocalizedName(product);
                    this.showToast(this.lang === 'ar' ? `ØªÙ… Ø¥Ø¶Ø§ÙØ© ${name} Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©` : `Added ${name} to cart`);
                },

                removeFromCart(id) {
                    this.cartItems = this.cartItems.filter(item => item.id !== id);
                },

                clearCart() {
                    const msg = this.lang === 'ar' ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¹Ø±Ø¨Ø©ØŸ' : 'Are you sure you want to clear your cart?';
                    if(confirm(msg)) {
                        this.cartItems = [];
                    }
                },

                updateQuantity(id, delta) {
                    const item = this.cartItems.find(i => i.id === id);
                    if (item) {
                        item.quantity = Math.max(1, item.quantity + delta);
                    }
                },

                checkout() {
                    if (this.cartItems.length === 0) return;
                    this.showCheckoutForm = true;
                },

                confirmOrder() {
                    const phoneNumber = "201155076155"; // Egypt code +20
                    let message = this.lang === 'ar' ? "*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø¯ÙŠ*\n\n" : "*New Order from El-Nagdy Pharmacy*\n\n";

                    // Customer Details
                    message += `ðŸ‘¤ *${this.customer.name}*\n`;
                    message += `ðŸ“ ${this.customer.address}\n`;
                    if (this.customer.landmark) {
                        message += `ðŸ¢ ${this.customer.landmark}\n`;
                    }
                    message += "\n-------------------\n";

                    // Order Items
                    this.cartItems.forEach((item, index) => {
                        const name = this.getLocalizedName(item);
                        message += `${index + 1}. ${name} (x${item.quantity})\n`;
                        message += `   ${item.price.toFixed(2)} EGP\n`;
                    });

                    message += "\n-------------------\n";
                    
                    if (this.lang === 'ar') {
                        message += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${this.cartSubtotal.toFixed(2)} EGP\n`;
                        message += `Ø§Ù„ØªÙˆØµÙŠÙ„: ${this.deliveryFee.toFixed(2)} EGP\n`;
                        message += `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${this.cartTotal.toFixed(2)} EGP*`;
                    } else {
                        message += `Subtotal: ${this.cartSubtotal.toFixed(2)} EGP\n`;
                        message += `Delivery: ${this.deliveryFee.toFixed(2)} EGP\n`;
                        message += `*Total: ${this.cartTotal.toFixed(2)} EGP*`;
                    }

                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                    
                    window.open(whatsappUrl, '_blank');
                    
                    this.showToast(this.lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨...' : 'Opening WhatsApp...');
                    
                    // Reset cart and form after checkout
                    setTimeout(() => {
                        this.cartItems = [];
                        this.isCartOpen = false;
                        this.showCheckoutForm = false;
                        this.customer = { name: '', address: '', landmark: '' };
                    }, 1000);
                }
            }
        }
    </script>
</body>
</html>
